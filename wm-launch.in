#!/bin/sh

# wm-launch - launch X11 clients with unique IDs
# Copyright (C) 2019-2020 James Reed

# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Lesser General Public
# License as published by the Free Software Foundation; either
# version 2.1 of the License, or (at your option) any later version.

# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# Lesser General Public License for more details.

# You should have received a copy of the GNU Lesser General Public
# License along with this library; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA

set -eu

readonly LIBPREFIX=
readonly VERSION=

readonly PRELOAD="${WM_LAUNCH_PRELOAD:-$LIBPREFIX/wm-launch/wm-launch-preload.so}"

readonly WORKSPACE_LAUNCHER="${WM_LAUNCH_WORKSPACE_LAUNCHER:-$LIBPREFIX/wm-launch/wm-launch-workspace}"
readonly WORKSPACE_FILENAME="${WM_LAUNCH_WORKSPACE_FILENAME:-.workspace}"

readonly SYSTEMD_RUN='systemd-run --user --scope'

usage() {
    echo 'usage: wm-launch [options] WM_LAUNCH_ID COMMAND...

options:
  -h          Show help message
  -s          Launch with systemd-run
  -j          Launch with firejail
  -f FACTORY  Launch via a window factory
  -w DIR      Launch workspace from DIR
  -v          Show version'
}

usage_error() {
    usage >&2
    exit 2
}

workspace() {
    "$WORKSPACE_LAUNCHER" "$1/$WORKSPACE_FILENAME"
}

while getopts ':hsjf:w:v' opt; do
    case "$opt" in
        h) usage; exit ;;
        s) systemd=true ;;
        j) firejail=true ;;
        f) factory="$OPTARG" ;;
        w) workspace "$OPTARG"; exit ;;
        v) echo "$VERSION"; exit ;;
        *) usage_error
    esac
done

shift $((OPTIND - 1))

if [ -z "$DISPLAY" ]; then
    echo 'DISPLAY not set' >&2
    exit 1
fi

[ $# -lt 2 ] && usage_error

launch_id="$1"
shift

launch_env="WM_LAUNCH_ID=$launch_id"

if [ -n "${factory+x}" ]; then
    if [ -n "$factory" ]; then
        if wm-launchd -factory "$factory"; then
            launch_env=""
        else
            launch_env="WM_LAUNCH_FACTORY=$factory"
        fi
        wm-launchd -factory "$factory" -id "$launch_id"
    else
        launch_env="WM_LAUNCH_FACTORY= $launch_env"
    fi
fi

if [ -n "${firejail-}" ]; then
    exec ${systemd+$SYSTEMD_RUN} firejail \
        ${launch_env+--env=LD_PRELOAD="$PRELOAD" --env="$launch_env"} "$@"
fi

exec ${launch_env+env LD_PRELOAD="$PRELOAD" $launch_env} \
    ${systemd+$SYSTEMD_RUN} "$@"
